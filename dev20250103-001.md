# QUIC Core Package 开发文档

## 工作内容概述

### 需求背景

作为QUIC协议重构计划的第一个包，quic-core是整个QUIC协议栈的基础设施包。负责提供所有QUIC协议的核心定义、常量、枚举和基础数据结构，为其他所有包提供统一的基础API。

### 核心功能

1. 协议版本常量定义（QUIC Version 1: 0x00000001）
2. 错误码枚举实现（QuicError - 涵盖RFC 9000定义的所有错误类型）
3. 连接状态枚举（ConnectionState - NEW, HANDSHAKING, CONNECTED等）
4. 帧类型枚举（FrameType - PADDING, PING, ACK, STREAM等）
5. 包类型枚举（PacketType - INITIAL, HANDSHAKE, RETRY等）
6. 变长整数编解码器（支持1-8字节变长整数）
7. 连接ID生成器（支持0-20字节连接ID）
8. 基础异常类（QuicException及其子类）
9. 协议常量定义（默认超时、最大值等）
10. 通用工具类和辅助函数

### 技术范围

- PHP 8.1+ 现代语法特性
- PSR-4 自动加载规范
- PHPUnit 10+ 单元测试
- PHPStan Level 9 静态分析
- 严格类型声明和枚举支持

## 任务拆分与进度计划

| 任务阶段 | 具体任务项 | 优先级 | 预估耗时 | 进度状态（⏳/🔄/✅） | 责任人 |
|---------|-----------|--------|----------|-------------------|--------|
| 基础设施 | 1. 创建包目录结构和composer.json | P0 | 1h | ⏳ | AI工具 |
|         | 2. 设置PHPUnit和PHPStan配置 | P0 | 1h | ⏳ | AI工具 |
|         | 3. 创建基础命名空间和自动加载 | P0 | 0.5h | ⏳ | AI工具 |
| 核心枚举 | 1. 实现QuicError错误码枚举 | P0 | 2h | ⏳ | AI工具 |
|         | 2. 实现ConnectionState连接状态枚举 | P0 | 1h | ⏳ | AI工具 |
|         | 3. 实现FrameType帧类型枚举 | P0 | 2h | ⏳ | AI工具 |
|         | 4. 实现PacketType包类型枚举 | P0 | 1h | ⏳ | AI工具 |
| 工具类 | 1. 实现VariableInteger变长整数编解码 | P0 | 4h | ⏳ | AI工具 |
|        | 2. 实现ConnectionId连接ID生成器 | P0 | 2h | ⏳ | AI工具 |
|        | 3. 实现Constants协议常量类 | P0 | 1h | ⏳ | AI工具 |
| 异常处理 | 1. 实现QuicException基础异常类 | P1 | 2h | ⏳ | AI工具 |
|          | 2. 实现具体异常子类 | P1 | 3h | ⏳ | AI工具 |
| 测试实现 | 1. 编写所有枚举的单元测试 | P0 | 4h | ⏳ | AI工具 |
|          | 2. 编写VariableInteger的测试用例 | P0 | 3h | ⏳ | AI工具 |
|          | 3. 编写ConnectionId的测试用例 | P0 | 2h | ⏳ | AI工具 |
|          | 4. 编写异常类的测试用例 | P1 | 2h | ⏳ | AI工具 |
| 文档完善 | 1. 编写API文档和使用示例 | P1 | 3h | ⏳ | AI工具 |
|          | 2. 编写RFC对应关系文档 | P1 | 2h | ⏳ | AI工具 |

## 验收条件清单

### 功能验收

- 所有PHP文件都应通过phpstan Level 9校验：`./vendor/bin/phpstan analyse packages/quic-core/src -l 9`
- 所有枚举类型都有完整的方法实现和文档注释
- VariableInteger能正确编解码1-8字节的变长整数
- ConnectionId能生成符合RFC规范的连接ID（0-20字节）
- 所有常量值与RFC 9000规范完全一致
- 异常类层次结构清晰，错误信息详细

### 测试验收

- 单元测试覆盖率达到95%以上
- 所有边界条件都有对应测试用例
- 性能测试：VariableInteger编解码性能 > 1M ops/sec
- 内存测试：所有操作无内存泄漏

### 文档验收

- README.md包含完整的安装和使用说明
- 所有公共API都有详细的PHPDoc注释
- 提供完整的代码示例和最佳实践

### 合规验收

- 严格遵循PSR-4、PSR-12代码规范
- 所有类和方法都有正确的类型声明
- 通过PHP 8.1+兼容性测试
- 符合项目的编码标准和安全要求

## 特殊备注说明

### 技术难点

1. **变长整数实现**：需要严格按照RFC 9000 Section 16实现，支持1/2/4/8字节编码
2. **枚举方法扩展**：为所有枚举添加便利方法，如isError()、canTransition()等
3. **性能优化**：核心编解码函数需要高性能，考虑使用位运算优化

### 依赖关系

- **无外部依赖**：作为基础包，不依赖任何其他QUIC包
- **PHP扩展依赖**：需要mbstring扩展用于字节操作
- **开发依赖**：PHPUnit、PHPStan、Composer

### 输出接口

```php
namespace Tourze\QUIC\Core;

// 核心常量
class Constants {
    public const VERSION_1 = 0x00000001;
    public const MAX_PACKET_SIZE = 65535;
    public const DEFAULT_IDLE_TIMEOUT = 30;
}

// 错误码枚举
enum QuicError: int {
    case NO_ERROR = 0x0;
    case INTERNAL_ERROR = 0x1;
    case CONNECTION_REFUSED = 0x2;
    // ... 其他错误码
    
    public function isConnectionError(): bool;
    public function isApplicationError(): bool;
}

// 连接状态枚举
enum ConnectionState: string {
    case NEW = 'new';
    case HANDSHAKING = 'handshaking';
    case CONNECTED = 'connected';
    case CLOSING = 'closing';
    case CLOSED = 'closed';
    
    public function canSendData(): bool;
    public function canReceiveData(): bool;
}

// 帧类型枚举
enum FrameType: int {
    case PADDING = 0x00;
    case PING = 0x01;
    case ACK = 0x02;
    // ... 其他帧类型
    
    public function isFlowControlled(): bool;
    public function needsReliableDelivery(): bool;
}

// 包类型枚举
enum PacketType: int {
    case INITIAL = 0x00;
    case ZERO_RTT = 0x01;
    case HANDSHAKE = 0x02;
    case RETRY = 0x03;
    
    public function isLongHeader(): bool;
    public function isEncrypted(): bool;
}

// 变长整数编解码器
class VariableInteger {
    public static function encode(int $value): string;
    public static function decode(string $data, int $offset = 0): array;
    public static function getLength(int $value): int;
}

// 连接ID生成器
class ConnectionId {
    public static function generate(int $length = 8): string;
    public static function validate(string $connectionId): bool;
    public static function random(): string;
}

// 基础异常
class QuicException extends \Exception {
    public function __construct(string $message, QuicError $errorCode);
    public function getQuicError(): QuicError;
}
```

## 执行流程说明

1. **环境准备**：确保PHP 8.1+环境，安装Composer依赖
2. **基础架构**：创建目录结构，配置自动加载和测试框架
3. **核心实现**：按优先级实现枚举、工具类、异常处理
4. **测试验证**：编写全面的单元测试，确保功能正确性
5. **文档完善**：编写详细的API文档和使用示例
6. **集成验证**：与其他包的集成测试（在后续包开发时进行）

### 关键里程碑

- **Week 1 End**：完成所有核心枚举和基础工具类
- **Week 2 End**：完成所有测试用例和文档，达到发布标准

---
*此文档将在开发过程中持续更新，记录重要的设计决策和实现细节*
